<!-- 2026-02-25 | v0.1 | AGPLv3 | @aaviator42 | https://github.com/aaviator42/shellinabox-plus -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mobile Shell</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #111;
      --surface:  #1e1e1e;
      --border:   #2e2e2e;
      --text:     #ddd;
      --muted:    #666;
      --accent:   #4a9eff;
      --danger:   #ff5555;
      --success:  #4caf50;
      --warn:     #ff9800;
      --btn-h:    44px;
      --radius:   8px;
      --gap:      8px;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .layout {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Terminal box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .terminal-box {
      flex: 1 1 0;
      position: relative;
      background: #000;
      overflow: hidden;
      min-height: 0;
    }

    #term {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    /* Frozen snapshot shown when paused */
    #pause-overlay {
      position: absolute;
      inset: 0;
      background: #000;
      color: #ccc;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      line-height: 1.4;
      padding: 8px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      display: none;
      z-index: 10;
    }

    #pause-banner {
      position: sticky;
      top: 0;
      background: rgba(255,140,0,0.92);
      color: #fff;
      font-family: system-ui, sans-serif;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 0.05em;
      text-align: center;
      padding: 4px 8px;
      border-radius: 0 0 6px 6px;
      margin: -8px -8px 8px -8px;
      pointer-events: none;
    }

    /* â”€â”€ Controls panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      flex-shrink: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: var(--gap);
      padding-bottom: calc(var(--gap) + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }

    /* row of action buttons */
    .btn-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .btn-row .spacer { flex: 1; }

    /* â”€â”€ Button groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-group {
      display: flex;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .btn-group button {
      border-radius: 0;
    }

    .btn-group button + button {
      border-left: 1px solid var(--border);
    }

    /* input row */
    .input-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    /* â”€â”€ Button base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    button {
      height: var(--btn-h);
      border: none;
      background: var(--bg);
      color: var(--text);
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: normal;
      font-family: inherit;
      cursor: pointer;
      padding: 0 12px;
      white-space: nowrap;
      user-select: none;
      -webkit-user-select: none;
      transition: background 80ms, opacity 80ms;
      -webkit-appearance: none;
    }

    button:active { opacity: 0.7; }

    /* Ctrl+C */
    #btn-ctrlc {
      color: var(--danger);
    }

    /* Copy / Download â€” neutral accent */
    #btn-copy, #btn-dl {
      color: var(--accent);
    }

    /* Pause / Resume */
    #btn-pause {
      color: var(--success);
    }
    #btn-pause.is-paused {
      color: var(--warn);
    }

    /* Terminal arrow keys â€” blue */
    #btn-arrup, #btn-arrdn {
      font-size: 16px;
      color: var(--accent);
    }

    /* Input history navigation â€” amber */
    #btn-histup, #btn-histdn {
      font-size: 16px;
      color: #e6a817;
    }

    /* Enter */
    #btn-send {
      flex-shrink: 0;
      padding: 0 16px;
    }

    /* â”€â”€ Text input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #cmd-input {
      flex: 1;
      min-width: 0;
      height: var(--btn-h);
      background: #0d0d0d;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      padding: 0 10px;
      outline: none;
      -webkit-appearance: none;
      caret-color: var(--accent);
    }

    #cmd-input:focus { border-color: #a78bfa; }

    /* â”€â”€ Status toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: calc(var(--btn-h) * 2 + var(--gap) * 3 + 12px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(74,158,255,0.9);
      color: #fff;
      font-size: 13px;
      padding: 6px 16px;
      border-radius: 20px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
      z-index: 100;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>

<div class="layout">

  <div class="terminal-box">
    <iframe id="term" src="/" title="Shell Terminal" allowfullscreen></iframe>
    <div id="pause-overlay">
      <div id="pause-banner">&#9646;&#9646; PAUSED â€” tap Resume to continue</div>
      <span id="pause-content"></span>
    </div>
  </div>

  <div class="controls">
    <div class="btn-row">
      <div class="btn-group">
        <button id="btn-esc">Esc</button>
        <button id="btn-ctrlc">^C</button>
        <button id="btn-arrup">&#9650;</button>
        <button id="btn-arrdn">&#9660;</button>
      </div>
      <div class="btn-group">
        <button id="btn-histup">&#9650;</button>
        <button id="btn-histdn">&#9660;</button>
      </div>
      <div class="spacer"></div>
      <div class="btn-group">
        <button id="btn-copy">ğŸ“‹</button>
        <button id="btn-dl">â¬‡</button>
        <button id="btn-pause">â¸</button>
      </div>
    </div>
    <div class="input-row">
      <input
        id="cmd-input"
        type="text"
        placeholder="type commandâ€¦"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        enterkeyhint="send"
      >
      <div class="btn-group"><button id="btn-send">Enter</button></div>
    </div>
  </div>

</div>

<div id="toast"></div>

<script>
(function () {
  'use strict';

  const term      = document.getElementById('term');
  const input     = document.getElementById('cmd-input');
  const overlay   = document.getElementById('pause-overlay');
  const pauseText = document.getElementById('pause-content');
  const btnPause  = document.getElementById('btn-pause');
  const toast     = document.getElementById('toast');

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let isPaused    = false;
  let history     = [];       // commands entered via our UI
  let histIdx     = -1;       // -1 = current (unsaved) input
  let pendingCmd  = '';       // saved draft when browsing history

  // Accumulated output via postMessage relay
  let outputBuffer = '';
  let outputEnabled = false;

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function showToast(msg, dur) {
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toast.classList.remove('show'), dur || 1800);
  }

  /** Direct same-origin access to the shellinabox object. */
  function shell() {
    try {
      const w = term.contentWindow;
      return (w && w.shellinabox) ? w.shellinabox : null;
    } catch (e) { return null; }
  }

  /**
   * Send a string to the terminal.
   * Prefers direct same-origin API; falls back to postMessage.
   */
  function send(str) {
    const s = shell();
    if (s) {
      s.keysPressed(str);
    } else {
      // postMessage fallback (requires --messages-origin on daemon)
      try {
        term.contentWindow.postMessage(
          JSON.stringify({ type: 'input', data: str }), '*'
        );
      } catch (e) { /* ignore */ }
    }
  }

  /** Strip VT100/ANSI escape sequences from raw output. */
  function stripAnsi(str) {
    // eslint-disable-next-line no-control-regex
    return str.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '')
              .replace(/\x1b\][^\x07]*\x07/g, '')
              .replace(/[\x00-\x08\x0b-\x0c\x0e-\x1f]/g, '');
  }

  /**
   * Get current visible terminal text.
   * Tries reading the DOM directly (same-origin), falls back to outputBuffer.
   */
  function getOutput() {
    try {
      const doc = term.contentDocument;
      if (!doc) throw new Error('no doc');
      // shellinabox uses #scrollable inside #vt100
      const el = doc.getElementById('scrollable') || doc.getElementById('vt100');
      if (el) return el.innerText || el.textContent || '';
      throw new Error('no scrollable');
    } catch (e) {
      // Return cleaned postMessage buffer as fallback
      return outputBuffer ? stripAnsi(outputBuffer) : '(output unavailable)';
    }
  }

  // â”€â”€ postMessage output relay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  window.addEventListener('message', function (ev) {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'ready') {
        // Terminal iframe is ready â€” enable output relay
        ev.source.postMessage(
          JSON.stringify({ type: 'output', data: 'enable' }), '*'
        );
        outputEnabled = true;
      } else if (msg.type === 'output') {
        outputBuffer += msg.data;
        // Keep buffer from growing unboundedly (~500 KB)
        if (outputBuffer.length > 512000) {
          outputBuffer = outputBuffer.slice(-256000);
        }
      }
    } catch (e) { /* not a shellinabox message */ }
  });

  // â”€â”€ Ctrl+C â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-ctrlc').addEventListener('click', function () {
    send('\x03');
  });

  // â”€â”€ Arrow keys / Esc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-arrup').addEventListener('click', function () {
    send('\x1b[A');
  });
  document.getElementById('btn-arrdn').addEventListener('click', function () {
    send('\x1b[B');
  });
  document.getElementById('btn-esc').addEventListener('click', function () {
    send('\x1b');
  });

  // â”€â”€ Send command â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function doSend() {
    const cmd = input.value;
    if (cmd.trim()) {
      // Push to history (deduplicate consecutive identical commands)
      if (!history.length || history[0] !== cmd) {
        history.unshift(cmd);
        if (history.length > 200) history.pop();
      }
    }
    histIdx  = -1;
    pendingCmd = '';
    send(cmd + '\r');
    input.value = '';
    // Keep focus so the user can type another command immediately,
    // but on mobile the keyboard stays up â€” which is fine for rapid entry.
  }

  document.getElementById('btn-send').addEventListener('click', doSend);
  input.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') { e.preventDefault(); doSend(); }
  });

  // â”€â”€ History navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setInputFromHistory(idx) {
    input.value = history[idx];
  }

  document.getElementById('btn-histup').addEventListener('click', function () {
    if (!history.length) return;
    if (histIdx === -1) pendingCmd = input.value;
    histIdx = Math.min(histIdx + 1, history.length - 1);
    setInputFromHistory(histIdx);
  });

  document.getElementById('btn-histdn').addEventListener('click', function () {
    if (histIdx === -1) return;
    histIdx--;
    input.value = histIdx === -1 ? pendingCmd : history[histIdx];
  });

  // â”€â”€ Copy output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-copy').addEventListener('click', function () {
    const text = getOutput();
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text)
        .then(function () { showToast('Copied to clipboard'); })
        .catch(function () { fallbackCopy(text); });
    } else {
      fallbackCopy(text);
    }
  });

  function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); showToast('Copied to clipboard'); }
    catch (e) { showToast('Copy failed'); }
    document.body.removeChild(ta);
  }

  // â”€â”€ Download output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-dl').addEventListener('click', function () {
    const text = getOutput();
    const ts   = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
    const a    = document.createElement('a');
    a.href     = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
    a.download = 'shell-' + ts + '.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('Download started');
  });

  // â”€â”€ Pause / Resume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  btnPause.addEventListener('click', function () {
    isPaused = !isPaused;
    if (isPaused) {
      // Snapshot current terminal content
      pauseText.textContent = getOutput();
      overlay.style.display = 'block';
      btnPause.textContent  = 'â–¶';
      btnPause.classList.add('is-paused');
    } else {
      overlay.style.display = 'none';
      btnPause.textContent  = 'â¸';
      btnPause.classList.remove('is-paused');
    }
  });

  // â”€â”€ Refocus input after any button press â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function focusInputEnd() {
    input.focus();
    setTimeout(function () {
      const len = input.value.length;
      input.setSelectionRange(len, len);
    }, 0);
  }

  document.querySelector('.controls').addEventListener('click', function (e) {
    if (e.target.tagName === 'BUTTON' && e.target.id !== 'btn-send') {
      focusInputEnd();
    }
  });

  // â”€â”€ Fit layout to visual viewport (keyboard open/close) â”€
  var layout = document.querySelector('.layout');

  function fitViewport() {
    var vv = window.visualViewport;
    var h  = vv ? vv.height    : window.innerHeight;
    var t  = vv ? vv.offsetTop : 0;
    layout.style.height = h + 'px';
    layout.style.top    = t + 'px';
  }

  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', fitViewport);
    window.visualViewport.addEventListener('scroll', fitViewport);
  } else {
    window.addEventListener('resize', fitViewport);
  }
  fitViewport();

}());
</script>
</body>
</html>
